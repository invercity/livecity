<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title> 16 route bus test</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript" src="./js/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCtoc2CLiq0QkGfdVKuyxJPhMfvSvNriRo&sensor=false&language=uk"></script> 
        <style type="text/css">
            html { height: 100% }
            body { height: 100%; margin: 0px; padding: 0px }
            #map_canvas { height: 100% }
        </style>
    </head>
    <body onload="map()">
        <div id="map_canvas">
            &nbsp;
        </div>
        <script type="text/javascript">
            var id = -1;
            var _id = -1;
            var station_id = -1;
            function map() {
                var pos = new google.maps.LatLng(51.4982000,31.2893500);
                var settings = {
                    zoom: 15,
                    center: pos,
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle,
                        position: google.maps.ControlPosition.BOTTOM_LEFT
                    },
                    navigationControl: true,
                    navigationControlOptions: {
                        style: google.maps.NavigationControlStyle.SMALL
                    },
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                var m = new google.maps.Map(document.getElementById("map_canvas"), settings);
                var marker = new google.maps.Marker({
                    position: pos, 
                    map: m,
                    draggable: true
                });
                google.maps.event.addListener(marker, 'dragend', function(event) {
                    upd(event.latLng);
                });
                $.ajax({
                    datatype: 'json',
                    type: 'POST',
                    url: 'http://178.54.56.121:3000/work?act=init',
                    data: {
                        lat: pos.lat(),
                        lng: pos.lng()
                    },
                    success: function(result) {
                        id = result.routes[0]._id;
                        _id = result.trans._id;
                        alert(_id);
                    }
                })
            };
               function upd (pos) {
                   var json = {};
                    var data = {};
                    // fill properties
                    data.type = "SEND_TRANS";
                    json.a = pos.lat();
                    json.b = pos.lng();
                    json.id_route = id;
                    json._id = _id;
                    json.id_station = station_id;
                    data.data = json;
                    $.ajax({
                        datatype: 'json',
                        type: 'POST',
                        url: 'http://178.54.56.121:8880/',
                        data: JSON.stringify(data),
                        success: function(result) {
                            station_id = result.id_station;
                        }
                    });
               }
        </script>
    </body>
</html>
