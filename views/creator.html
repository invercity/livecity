<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title> Create temporary points </title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="./js/jquery-1.9.1.min.js"></script>
        <script src="js/async.js"></script>
        <script src="http://maps.google.com/maps/api/js?key=AIzaSyCtoc2CLiq0QkGfdVKuyxJPhMfvSvNriRo&sensor=false&language=uk"></script>

        <link rel="shortcut icon" href="img/favicon.ico" type="image/gif">

        <style type="text/css">
            html { height: 100% }
            body { height: 100%; margin: 0px; padding: 0px }
            #map_canvas { height: 100% }
        </style>
    </head>
    <body onload="initialize()">
        <!-- START/END BUTTON -->
        <div style="position: absolute; height: 20px; width: 50px; z-index: 1000; right: 0">
            <button id="act" onclick="dropAll()"> Drop </button>
        </div>
        <!-- MAP -->
        <div id="map_canvas">
            &nbsp;
        </div>
        <script type="text/javascript">
            // buffer for markers
            var markers = [];
            // init function (create map and load existing markers from server)
            function initialize() {
                var settings = {
                    zoom: 15,
                    center: new google.maps.LatLng(51.4982000,31.2893500),
                    mapTypeControl: true,
                    draggableCursor: 'crosshair',
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle,
                        position: google.maps.ControlPosition.BOTTOM_LEFT
                    },
                    navigationControl: true,
                    navigationControlOptions: {
                        style: google.maps.NavigationControlStyle.SMALL
                    },
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                // create map
                var map = new google.maps.Map(document.getElementById("map_canvas"), settings);
                // add map click handler
                google.maps.event.addListener(map, 'click', function(event) {
                    addMarker(map, event.latLng);
                });
                // load existing markers
                $.ajax({
                    datatype: 'JSON',
                    type: 'GET',
                    url: 'http://178.54.56.121:3000/data/temp',
                    success: function(result) {
                        result.forEach(function(item) {
                            addMarker(map, new google.maps.LatLng(item.lat, item.lng));
                        });
                    }
                });
            };

            function addMarker(map, position) {
                markers.push(new google.maps.Marker({
                    position: position,
                    map: map
                }));
                $.ajax({
                    datatype: 'JSON',
                    type: 'POST',
                    url: 'http://178.54.56.121:3000/data/temp',
                    data: {
                        lat: position.lat(),
                        lng: position.lng(),
                        id: markers.length - 1
                    }
                });
            }
            function dropAll() {
                $.ajax({
                    datatype: 'JSON',
                    type: 'DELETE',
                    url: 'http://178.54.56.121:3000/data/temp',
                    success: function(result) {
                        async.each(markers, function(item, callback) {
                            item.setVisible(false);
                            callback();
                        }, function(err) {
                            markers = [];
                        });
                    }
                });
            }
        </script>
    </body>
</html>
