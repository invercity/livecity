<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <title> Livecity - official page </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="invercity" >
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    
    <!-- SCRIPTS --> 
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language=uk"></script>
    <script src="./engine/js/jquery-1.9.1.min.js"></script>
    <script src="./engine/js/main.js"></script>
    <script src="./engine/js/stations.js"></script>
    <script type="text/javascript">
        var map;
        var stations = [];
        var transport = [];
    </script>
    
    <!-- STYLES -->
    <link rel="stylesheet" href="engine/css/global.css">
    <link rel="stylesheet" href="engine/css/editor.css">
    <link rel="shortcut icon" href="engine/img/favicon.ico" type="image/gif">
    
  
    <!-- AJAX -->
    <script type="text/javascript">
    $(document).ready( function() {

            // Edit button click function
            document.documentElement.onkeydown = function(e) {
                    if (e.keyCode==27) $('#close_edit').click(); 
            };
            
            $("#edit").click(function () {
                //document.getElementById('edit_marker').style.display = 'block';
                $('#edit_marker').show('500');
                map.setOptions({ draggableCursor: 'crosshair'});
                //escape handler
                document.documentElement.onkeydown = function(e) {
                    if (e.keyCode==27) $('#cancel_edit').click(); 
                };
                //click handler
                google.maps.event.addListener(map, 'click', function(event){
                    addMarkerMap(map,stations,event.latLng);
                });
                // enable drag markers
                setDraggable(stations);
                //add marker handler
                for (var i=0;i<stations.length;i++) {
                    //adding to list
                  //  addToList(stations[i].position);
                    // click handler
                    google.maps.event.addListener(stations[i], 'click', function(event) {
                        //setDraggable(stations[i]);
                        markerClick(this.id,this.position,this.title,1);
                    });
                    // drag handler
                    google.maps.event.addListener(stations[i], 'drag', function(event) {
                        markerClick(this.id,this.position,this.title,0);
                    });
                }
            });
            
            //focus lost function {
            $('#label_name').focusout(function (event) {
            
            })
            // Close & save edit pane click handler
            $("#close_edit").click(function () {
                //console.log("id=" + $('#label_id').text());
                var senddata = '{"type" : "SEND_STATION",\n\
                        "id" : "' + $('#label_id').text() + 
                     '","pos_a" : "' + $('#label_posx').text() + 
                     '","pos_b" : "' + $('#label_posy').text() + 
                     '","name" : "' + $('#label_name').val() + '"}';
                $.ajax({
                    datatype: 'jsonp',
                    type: 'POST',
                    url: 'http://localhost:8888',
                    data: senddata,
                    jsonp: 'callback',
                    //contentType: "charset=utf-8",
                    cache: false,
                    success: function(result) {
                        var value = $('#label_id').text();
                        if (value[0] == 'i') {
                            var id = result[0];
                            var num = value.substring(2,value.length);
                            stations[num].set("id",id['id']);
                            $('#label_id').text(id['id']);
                        }
                    }
                    
                })
                console.log("saved");
                //$('#cancel_edit').click(); 
            });
            // Cancel edit click handler 
            $("#cancel_edit").click(function () {
                $('#edit_marker').hide('500');
                map.setOptions({ draggableCursor: 'pointer'});
                //unset click handler
                google.maps.event.clearListeners(map, 'click');
                //unset marler click handler
                for (var i=0;i<stations.length;i++) {
                    google.maps.event.clearListeners(stations, 'click');
                    google.maps.event.clearListeners(stations, 'drag');
                }
                // disable drag markers
                unsetDraggable(stations);
                //clear fields
                $("#label_posx").text("");
                $("#label_posy").text("");
                $("#label_name").val("");
                $("#label_id").text("");
            });
        
          $.ajax({
                datatype: 'jsonp',
                type: 'POST',
                url: 'http://localhost:8888',
                //contentType: "charset=utf-8",
                data: '{"type" : "GET_STATION"}',
                jsonp: 'callback',
                cache: false,
                success: function(result) {
                    for (var i=0;i<result.length;i++) {
                        var station = result[i];
                        //console.log(station['name']);  
                        stations.push(placeStation(map,station['id'],station['pos_a'],station['pos_b'],
                        station['name']));
                    }
                }
            });
        });
        
    //});
    </script>
    </head>
    
    <!-- MAPS API -->
    <body onload="map = initialize();">
        <div id="head"> 
        <ul>
            <li>
                <button class="menu-first" id="staions"> Stations </button>
            </li>
            <li>
                <button class="menu" id="routes"> Routes </button>
            </li>
            <li>  
                <input type="text" id="searchpane" placeholder="Search places...">
            </li>
            <li>
                <button class="next" id="edit">Edit</button>
            </li>
        </ul>
    </div>
    <div id="edit_marker"> 
        <center> Editing stations </center>
        <div>
            <div class="labels">
                <div id="label_id" style="display: none"></div>
                <div class="edit_labels"> Latitude: </div>
                <div class="edit_values" id="label_posx"> &nbsp; </div>
                <div class="edit_labels"> Longitude: </div>
                <div class="edit_values" id="label_posy"> &nbsp;</div>
                <div class="edit_labels"> Name: </div>
                <input id="label_name" type="text">
            </div>
            <div class="edit_controls">
                <button id='close_edit'> Save </button>
                <button id='cancel_edit' style="float: right; margin-right: 10px"> Cancel </button>
            </div>
            <div class="tab_control">
                <center> List of stations: </center>
            </div>
            <div id="marker_list">
                <ul id="ul_list">
                </ul>
            </div>
        </div>
    </div>
    <div id="map_canvas"></div>
 </body>
 </html>
